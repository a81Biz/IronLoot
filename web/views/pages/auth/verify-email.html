{% extends "layouts/auth.html" %}

{% block content %}
<style>
    .hidden { display: none !important; }
</style>
<div class="text-center">
    <h2 class="text-2xl font-bold text-white mb-6">Verificando tu cuenta...</h2>
    
    <div id="loading" class="animate-pulse">
        <div class="h-4 bg-slate-700 rounded w-3/4 mx-auto mb-4"></div>
        <p class="text-slate-400">Por favor espera un momento.</p>
    </div>

    <div id="success" class="hidden">
        <div class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">¡Cuenta Verificada!</h3>
        <p class="text-slate-400 mb-6">Tu correo ha sido confirmado exitosamente.</p>
        <a href="/login" class="btn btn-primary w-full">Iniciar Sesión</a>
    </div>

    <div id="error" class="hidden">
        <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">Error de Verificación</h3>
        <p id="error-message" class="text-slate-400 mb-6">El enlace es inválido o ha expirado.</p>
        <a href="/login" class="btn btn-outline w-full">Volver al Login</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        verify();
    });

    async function verify() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            showError('Token no encontrado');
            return;
        }

        try {
            // Use AuthFlow orchestrator
            await AuthFlow.verifyEmail({ token });
            // AuthFlow handles redirect to /profile usually, but verify-email page might want to show success message first.
            // AuthFlow implementation: 
            // async function verifyEmail({ token }) { ... window.location.href = '/profile'; ... }
            // So Flow redirects IMMEDIATELY.
            // If we want to show success message, we might need to adjust Flow or accept redirect.
            // The HTML has a nice success UI.
            // If Flow redirects, we won't see it. 
            // However, strictly "Flows orchestrate".
            // Implementation of AuthFlow.verifyEmail:
            /*
            async function verifyEmail({ token }) {
                try {
                    const res = await AuthService.verifyEmail(token);
                     if (res.accessToken) AuthState.setTokens(res);
                     else await AuthState.refreshUser(); // verify typically performs login/update
                    window.location.href = '/profile';
                    return true;
                } ...
            */
            // Ideally Flow returns result and let Page handle UI/Redirect if strictly decoupled, 
            // OR Flow handles everything. 
            // Current AuthFlow handles redirect.
            // So the legacy "Success UI" in verify-email.html will be skipped.
            // That's acceptable for "Strict Flow Architecture" if Flow dictates the UX.
            // OR I should change AuthFlow to NOT redirect if I want this page to handle it?
            // "Pages -> DOM manipulation ... calling Flows".
            // If Page wants to show success, Flow should return success.
            // But AuthFlow.verifyEmail currently has `window.location.href = '/profile'`.
            // I will respect AuthFlow behavior for now to be consistent with "Flows determine outcome".
            // So simply calling it will suffice.

        } catch (error) {
            console.error(error);
            showError(error.message || 'Error al verificar el correo');
        }
    }

    function showSuccess() {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('success').classList.remove('hidden');
    }

    function showError(msg) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error').classList.remove('hidden');
        document.getElementById('error-message').textContent = msg;
    }
</script>
{% endblock %}
