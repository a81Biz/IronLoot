// ===========================================
// Iron Loot - Prisma Schema
// ===========================================
// This schema defines the database structure for Iron Loot
// Reference: 03-modelo-registro-db.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER & AUTH TABLES
// ===========================================

/// User states enum
enum UserState {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  BANNED
}

/// Auction status enum
enum AuctionStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  CLOSED
  CANCELLED
}

/// User - Main user entity
model User {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Authentication
  email        String  @unique @db.VarChar(255)
  username     String  @unique @db.VarChar(50)
  passwordHash String  @map("password_hash") @db.VarChar(255)

  // Profile
  displayName String? @map("display_name") @db.VarChar(100)
  avatarUrl   String? @map("avatar_url") @db.Text

  // State
  state           UserState @default(PENDING_VERIFICATION)
  suspendedReason String?   @map("suspended_reason") @db.Text
  bannedReason    String?   @map("banned_reason") @db.Text

  // Seller status
  isSeller        Boolean   @default(false) @map("is_seller")
  sellerEnabledAt DateTime? @map("seller_enabled_at") @db.Timestamptz

  // Email verification
  emailVerifiedAt          DateTime? @map("email_verified_at") @db.Timestamptz
  emailVerificationToken   String?   @map("email_verification_token") @db.VarChar(255)
  emailVerificationExpiresAt DateTime? @map("email_verification_expires_at") @db.Timestamptz

  // Password reset
  passwordResetToken     String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpiresAt DateTime? @map("password_reset_expires_at") @db.Timestamptz

  // Relations
  sessions Session[]
  profile  Profile?
  auctions Auction[] // Relation as seller
  bids     Bid[]     // Relation as bidder
  ordersAsBuyer  Order[] @relation("OrdersBuyer")
  ordersAsSeller Order[] @relation("OrdersSeller")

  @@index([email], name: "idx_users_email")
  @@index([username], name: "idx_users_username")
  @@index([state], name: "idx_users_state")
  @@map("users")
}

/// Profile - Extended user profile data
model Profile {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relation
  userId String @unique @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Contact info
  phone String? @db.VarChar(20)

  // Address
  address    String? @db.Text
  city       String? @db.VarChar(100)
  country    String? @db.VarChar(100)
  postalCode String? @map("postal_code") @db.VarChar(20)

  @@index([userId], name: "idx_profiles_user")
  @@map("profiles")
}

/// Session - User sessions for refresh tokens
model Session {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relation
  userId String @map("user_id") @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Token
  refreshToken String   @unique @map("refresh_token") @db.VarChar(255)
  expiresAt    DateTime @map("expires_at") @db.Timestamptz

  // Session metadata
  ipAddress  String?   @map("ip_address") @db.VarChar(50)
  userAgent  String?   @map("user_agent") @db.Text
  lastUsedAt DateTime? @map("last_used_at") @db.Timestamptz
  revokedAt  DateTime? @map("revoked_at") @db.Timestamptz

  @@index([userId], name: "idx_sessions_user")
  @@index([refreshToken], name: "idx_sessions_token")
  @@index([expiresAt], name: "idx_sessions_expires")
  @@map("sessions")
}

// ===========================================
// AUCTION & COMMERCE TABLES
// ===========================================

/// Auction - Core auction entity
model Auction {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Info
  title         String  @db.VarChar(200)
  description   String  @db.Text
  slug          String  @unique @db.VarChar(255)
  images        Json    @default("[]") @db.JsonB

  // Pricing & Time
  startingPrice Decimal   @map("starting_price") @db.Decimal(10, 2)
  currentPrice  Decimal   @map("current_price") @db.Decimal(10, 2)
  startsAt      DateTime  @map("starts_at") @db.Timestamptz
  endsAt        DateTime  @map("ends_at") @db.Timestamptz

  // Status
  status        AuctionStatus @default(DRAFT)

  // Relations
  sellerId      String    @map("seller_id") @db.Uuid
  seller        User      @relation(fields: [sellerId], references: [id])
  bids          Bid[]

  order         Order?   // One-to-One relation: Auction -> Order

  @@index([sellerId], name: "idx_auctions_seller")
  @@index([status], name: "idx_auctions_status")
  @@index([endsAt], name: "idx_auctions_ends_at")
  @@map("auctions")
}

/// Bid - Auction bid entity
model Bid {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Amount
  amount Decimal @db.Decimal(10, 2)

  // Relations
  auctionId String  @map("auction_id") @db.Uuid
  auction   Auction @relation(fields: [auctionId], references: [id])

  bidderId String @map("bidder_id") @db.Uuid
  bidder   User   @relation(fields: [bidderId], references: [id])

  @@index([auctionId], name: "idx_bids_auction")
  @@index([bidderId], name: "idx_bids_bidder")
  @@index([amount], name: "idx_bids_amount")
  @@map("bids")
}

/// Order Status enum
enum OrderStatus {
  PENDING_PAYMENT
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

/// Order - Post-auction transaction
model Order {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Info
  totalAmount Decimal @map("total_amount") @db.Decimal(10, 2)
  status      OrderStatus @default(PENDING_PAYMENT)

  // Relations
  auctionId String  @unique @map("auction_id") @db.Uuid
  auction   Auction @relation(fields: [auctionId], references: [id])

  buyerId   String  @map("buyer_id") @db.Uuid
  buyer     User    @relation("OrdersBuyer", fields: [buyerId], references: [id])

  sellerId  String  @map("seller_id") @db.Uuid
  seller    User    @relation("OrdersSeller", fields: [sellerId], references: [id])

  @@index([buyerId], name: "idx_orders_buyer")
  @@index([sellerId], name: "idx_orders_seller")
  @@index([status], name: "idx_orders_status")
  @@map("orders")
}

// ===========================================
// OBSERVABILITY TABLES
// Reference: 03-modelo-registro-db.md
// ===========================================

/// Audit Events - Business events for auditing
/// Stores all significant business actions (bids, payments, etc.)
model AuditEvent {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Event identification
  eventType String   @map("event_type") @db.VarChar(100)
  timestamp DateTime @default(now()) @db.Timestamptz

  // Correlation
  traceId String @map("trace_id") @db.VarChar(100)
  env     String @db.VarChar(20)
  service String @db.VarChar(50)

  // Actor information
  actorType   String  @map("actor_type") @db.VarChar(20) // 'user' | 'system'
  actorUserId String? @map("actor_user_id") @db.Uuid

  // Target entity
  entityType String @map("entity_type") @db.VarChar(50)
  entityId   String @map("entity_id") @db.Uuid

  // Result
  result     String  @db.VarChar(20) // 'SUCCESS' | 'FAIL'
  reasonCode String? @map("reason_code") @db.VarChar(100)

  // Payload (whitelisted data only)
  payload        Json @default("{}") @db.JsonB
  payloadVersion Int  @default(1) @map("payload_version")

  @@index([entityType, entityId, timestamp(sort: Desc)], name: "idx_audit_events_entity")
  @@index([actorUserId, timestamp(sort: Desc)], name: "idx_audit_events_actor")
  @@index([traceId], name: "idx_audit_events_trace")
  @@index([eventType, timestamp(sort: Desc)], name: "idx_audit_events_type_time")
  @@map("audit_events")
}

/// Error Events - Captured errors (business + exceptions)
/// Stores all errors for debugging and monitoring
model ErrorEvent {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Correlation
  timestamp DateTime @default(now()) @db.Timestamptz
  traceId   String   @map("trace_id") @db.VarChar(100)
  env       String   @db.VarChar(20)
  service   String   @db.VarChar(50)

  // Error details
  errorCode       String  @map("error_code") @db.VarChar(100)
  message         String  @db.Text
  severity        String  @db.VarChar(20) // 'WARN' | 'ERROR'
  httpStatus      Int?    @map("http_status")
  isBusinessError Boolean @default(false) @map("is_business_error")

  // Request context
  httpMethod String? @map("http_method") @db.VarChar(10)
  httpPath   String? @map("http_path") @db.Text
  httpQuery  String? @map("http_query") @db.Text
  clientIp   String? @map("client_ip") @db.VarChar(50)
  userAgent  String? @map("user_agent") @db.Text

  // Actor
  actorUserId String? @map("actor_user_id") @db.Uuid

  // Target entity (if applicable)
  entityType String? @map("entity_type") @db.VarChar(50)
  entityId   String? @map("entity_id") @db.Uuid

  // Additional details
  details Json    @default("{}") @db.JsonB
  stack   String? @db.Text

  @@index([traceId], name: "idx_error_events_trace")
  @@index([errorCode, timestamp(sort: Desc)], name: "idx_error_events_code_time")
  @@index([actorUserId, timestamp(sort: Desc)], name: "idx_error_events_actor")
  @@index([entityType, entityId, timestamp(sort: Desc)], name: "idx_error_events_entity")
  @@index([httpStatus, timestamp(sort: Desc)], name: "idx_error_events_http")
  @@map("error_events")
}

/// Request Logs - HTTP request/response logs
/// For diagnostics and performance monitoring
model RequestLog {
  id        String   @id @default(uuid()) @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Correlation
  timestamp DateTime @default(now()) @db.Timestamptz
  traceId   String   @map("trace_id") @db.VarChar(100)
  env       String   @db.VarChar(20)
  service   String   @db.VarChar(50)

  // Request/Response
  httpMethod        String @map("http_method") @db.VarChar(10)
  httpPath          String @map("http_path") @db.Text
  httpStatus        Int    @map("http_status")
  durationMs        Int    @map("duration_ms")
  requestSizeBytes  Int?   @map("request_size_bytes")
  responseSizeBytes Int?   @map("response_size_bytes")

  // Actor
  actorUserId String? @map("actor_user_id") @db.Uuid
  actorState  String? @map("actor_state") @db.VarChar(50)

  // Client info
  clientIp  String? @map("client_ip") @db.VarChar(50)
  userAgent String? @map("user_agent") @db.Text
  clientApp String? @map("client_app") @db.VarChar(20)

  // Target entity (optional)
  entityType String? @map("entity_type") @db.VarChar(50)
  entityId   String? @map("entity_id") @db.Uuid

  @@index([traceId], name: "idx_request_logs_trace")
  @@index([httpPath, timestamp(sort: Desc)], name: "idx_request_logs_path_time")
  @@index([httpStatus, timestamp(sort: Desc)], name: "idx_request_logs_status_time")
  @@index([actorUserId, timestamp(sort: Desc)], name: "idx_request_logs_actor_time")
  @@map("request_logs")
}
